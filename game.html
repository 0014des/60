<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>60 Seconds: Ultimate Web Edition</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #dcdcdc;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 900px;
            background-color: #2b2b2b;
            border: 2px solid #555;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 5px;
            position: relative;
        }
        h1, h2, h3 { text-align: center; color: #ff5555; margin-top: 0; }
        p { line-height: 1.5; }

        /* ç”»é¢é·ç§»åˆ¶å¾¡ */
        .screen { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ãƒœã‚¿ãƒ³ */
        button {
            background: #444; color: white; border: 1px solid #666;
            padding: 8px 16px; cursor: pointer; transition: 0.2s; font-family: inherit; font-size: 14px;
        }
        button:hover { background: #666; transform: translateY(-2px); }
        button:disabled { background: #222; color: #555; cursor: not-allowed; transform: none; }
        
        .btn-large { width: 100%; padding: 15px; font-size: 1.2em; margin: 10px 0; }
        .btn-start { background-color: #d32f2f; border-color: #b71c1c; font-weight: bold; }
        .btn-start:hover { background-color: #e53935; }
        .btn-back { background: transparent; border: none; color: #888; text-decoration: underline; padding: 0; }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚«ãƒ¼ãƒ‰ */
        .mode-card {
            background: #333; border: 1px solid #444; padding: 20px; margin-bottom: 15px; cursor: pointer;
        }
        .mode-card:hover { border-color: #ffcc00; background: #3a3a3a; }

        /* ã‚·ãƒ§ãƒƒãƒ—ãƒ»ã‚¢ã‚¤ãƒ†ãƒ UI */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 10px;}
        .shop-item {
            background: #333; padding: 10px; text-align: center; border: 1px solid #444; user-select: none;
        }
        .shop-item.selected { border-color: #ffcc00; background: #443a1a; }
        .counter-ctrl { display: flex; justify-content: space-between; margin-top: 5px; }

        .difficulty-tabs { display: flex; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: #222; border: 1px solid #444; padding: 10px; }
        .tab-btn.active-tab { background: #d32f2f; border-color: #d32f2f; font-weight: bold; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .game-header { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px; margin-bottom: 15px; }
        .game-layout { display: flex; gap: 20px; }
        .left-panel { flex: 2; }
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* å®¶æ—ã‚«ãƒ¼ãƒ‰ */
        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .char-card {
            background: #333; border: 1px solid #555; padding: 10px; border-radius: 4px;
        }
        .char-card.dead { opacity: 0.4; filter: grayscale(100%); }
        .char-card.away { border-color: #e65100; background: #3e2723; }
        
        .char-info { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .status-bar { height: 6px; background: #222; margin: 3px 0; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s; }

        /* ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒãƒƒã‚¸ */
        .inventory-area { background: #222; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .inv-badge { background: #555; padding: 4px 8px; font-size: 0.9em; border-radius: 3px; display: inline-flex; align-items: center; gap: 5px;}

        /* æ—¥è¨˜ */
        .journal {
            background: #ddd; color: #222; padding: 15px; font-family: 'Times New Roman', serif;
            height: 250px; overflow-y: auto; border: 1px solid #999;
        }
        .journal p { margin: 0 0 8px 0; border-bottom: 1px dashed #ccc; padding-bottom: 4px; font-size: 0.95em; }

        /* æ¢ç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content { background: #333; padding: 25px; width: 450px; border: 1px solid #777; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">

    <!-- 1. ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
    <div id="screen-mode" class="screen active">
        <h1>60 SECONDS: WEB EDITION</h1>
        <p style="text-align:center; margin-bottom:30px">æ ¸çˆ†ç™ºã¾ã§æ®‹ã‚Šã‚ãšã‹ã€‚ã‚µãƒã‚¤ãƒãƒ«è¨ˆç”»ã‚’ç«‹ã¦ã‚ã€‚</p>

        <div class="mode-card" onclick="goToScenarioSelect()">
            <h3>ğŸ“œ ã‚·ãƒŠãƒªã‚ªãƒ¢ãƒ¼ãƒ‰</h3>
            <p>æ±ºã‚ã‚‰ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚»ãƒƒãƒˆã§æŒ‘æˆ¦ã—ã¾ã™ã€‚ã€Œåˆå¿ƒè€…å‘ã‘ã€ã€Œé˜²è¡›é‡è¦–ã€ãªã©ã€‚</p>
        </div>
        <div class="mode-card" onclick="goToCustomPrep()">
            <h3>ğŸ’ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ‰</h3>
            <p>ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦è‡ªç”±ã«ç‰©è³‡ã‚’é¸ã³ã¾ã™ã€‚é›£æ˜“åº¦ï¼ˆå®¹é‡ï¼‰ã‚’é¸æŠå¯èƒ½ã€‚</p>
        </div>
    </div>

    <!-- 2. ã‚·ãƒŠãƒªã‚ªé¸æŠç”»é¢ -->
    <div id="screen-scenario" class="screen">
        <button class="btn-back" onclick="switchScreen('screen-mode')">â† æˆ»ã‚‹</button>
        <h2>ã‚·ãƒŠãƒªã‚ªé¸æŠ</h2>
        <div id="scenario-list"></div> <!-- JSã§ç”Ÿæˆ -->
    </div>

    <!-- 3. ã‚«ã‚¹ã‚¿ãƒ æº–å‚™ç”»é¢ -->
    <div id="screen-custom" class="screen">
        <button class="btn-back" onclick="switchScreen('screen-mode')">â† æˆ»ã‚‹</button>
        <h2>ç‰©è³‡èª¿é”</h2>
        
        <div class="difficulty-tabs">
            <button class="tab-btn active-tab" onclick="setCustomDiff('easy', this)">ç°¡å˜ (30pt)</button>
            <button class="tab-btn" onclick="setCustomDiff('normal', this)">æ™®é€š (20pt)</button>
            <button class="tab-btn" onclick="setCustomDiff('hard', this)">å›°é›£ (10pt)</button>
        </div>

        <div style="text-align:right; color:#ffcc00; margin-bottom:5px;">
            å®¹é‡: <span id="cap-current">0</span> / <span id="cap-max">20</span>
        </div>

        <div class="shop-grid" id="shop-container"></div>
        
        <button class="btn-large btn-start" onclick="startGameCustom()">ã‚·ã‚§ãƒ«ã‚¿ãƒ¼ã«å…¥ã‚‹</button>
    </div>

    <!-- 4. ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <div>Day: <span id="val-day">1</span></div>
            <div style="color:#4caf50">æ•‘åŠ©ç‡: <span id="val-rescue">0</span>%</div>
        </div>

        <div class="game-layout">
            <!-- å·¦ã‚«ãƒ©ãƒ : å®¶æ—ãƒ»ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª -->
            <div class="left-panel">
                <div id="family-area" class="family-grid"></div>
                
                <h3>ğŸ“¦ å‚™è“„ç‰©è³‡</h3>
                <div id="inventory-area" class="inventory-area"></div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ : æ—¥è¨˜ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="right-panel">
                <div class="journal" id="journal-log">
                    <p>é¿é›£æˆåŠŸã€‚ã“ã“ãŒæˆ‘ã€…ã®æ–°ã—ã„å®¶ã ã€‚</p>
                </div>

                <div style="background:#222; padding:10px; border:1px solid #444;">
                    <button id="btn-expedition" class="btn-large" style="background:#e65100; border-color:#bf360c; margin-top:0;" onclick="openExpedition()">
                        ğŸ” æ¢ç´¢ã¸å‡ºã™
                    </button>
                    <button class="btn-large btn-start" onclick="nextDay()">
                        ğŸŒ™ ä¸€æ—¥ã‚’çµ‚ãˆã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
    <div id="screen-result" class="screen" style="text-align:center; padding:50px;">
        <h1 id="res-title">GAME OVER</h1>
        <p id="res-msg" style="font-size:1.2em;"></p>
        <button class="btn-large" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>

</div>

<!-- æ¢ç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-overlay">
    <div class="modal-content">
        <h3>æ¢ç´¢ã®æº–å‚™</h3>
        <p>èª°ã‚’å¤–ã«é€ã‚Šã¾ã™ã‹ï¼Ÿï¼ˆ3ã€œ5æ—¥å¸°é‚„ã—ã¾ã›ã‚“ï¼‰</p>
        <select id="sel-exp-char" style="width:100%; padding:10px; background:#444; color:white; margin-bottom:15px;"></select>
        
        <p>æŒãŸã›ã‚‹è£…å‚™:</p>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <label><input type="checkbox" id="chk-mask"> ğŸ˜· ãƒã‚¹ã‚¯</label>
            <label><input type="checkbox" id="chk-map"> ğŸ—º åœ°å›³</label>
            <label><input type="checkbox" id="chk-gun"> ğŸ”« éŠƒ</label>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <button onclick="document.getElementById('modal-overlay').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style="background:#e65100; color:white;" onclick="confirmExpedition()">å‡ºç™ºï¼</button>
        </div>
    </div>
</div>

<script>
/** 
 * --- å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
 */
const ITEMS = {
    soup: { name: 'ã‚¹ãƒ¼ãƒ—', icon: 'ğŸ¥«', cost: 1, type: 'consumable' },
    water: { name: 'æ°´', icon: 'ğŸ’§', cost: 1, type: 'consumable' },
    medkit: { name: 'æ•‘æ€¥ç®±', icon: 'ğŸ’Š', cost: 3, type: 'tool' },
    mask: { name: 'ãƒã‚¹ã‚¯', icon: 'ğŸ˜·', cost: 2, type: 'tool' },
    radio: { name: 'ãƒ©ã‚¸ã‚ª', icon: 'ğŸ“»', cost: 2, type: 'tool' },
    gun: { name: 'ãƒ©ã‚¤ãƒ•ãƒ«', icon: 'ğŸ”«', cost: 3, type: 'tool' },
    map: { name: 'åœ°å›³', icon: 'ğŸ—º', cost: 2, type: 'tool' },
    axe: { name: 'æ–§', icon: 'ğŸª“', cost: 3, type: 'tool' },
    bugspray: { name: 'æ®ºè™«å‰¤', icon: 'ğŸ’¨', cost: 2, type: 'tool' },
    cards: { name: 'ãƒˆãƒ©ãƒ³ãƒ—', icon: 'ğŸƒ', cost: 1, type: 'tool' },
    flashlight: { name: 'ãƒ©ã‚¤ãƒˆ', icon: 'ğŸ”¦', cost: 2, type: 'tool' }
};

const CHARACTERS = [
    { id: 'dad', name: 'ãƒ†ãƒƒãƒ‰(çˆ¶)', icon: 'ğŸ‘¨ğŸ»' },
    { id: 'mom', name: 'ãƒ‰ãƒ­ãƒ¬ã‚¹(æ¯)', icon: 'ğŸ‘©ğŸ¼' },
    { id: 'sis', name: 'ãƒ¡ãƒªãƒ¼(å§‰)', icon: 'ğŸ‘§ğŸ»' },
    { id: 'bro', name: 'ãƒ†ã‚£ãƒŸãƒ¼(å¼Ÿ)', icon: 'ğŸ‘¦ğŸ»' }
];

const SCENARIOS = [
    { id: 's1', title: 'ğŸ”° åˆå¿ƒè€…ã‚­ãƒƒãƒˆ', desc: 'é£Ÿæ–™ã¨æ°´ãŒè±Šå¯Œã€‚ãƒ©ã‚¸ã‚ªã¨è–¬ã‚‚ã‚ã‚Šå®‰å®šã—ã¦ã„ã‚‹ã€‚', inv: { soup:5, water:5, radio:1, medkit:1, cards:1 } },
    { id: 's2', title: 'ğŸ›¡ï¸ æ­¦è£…ã‚­ãƒ£ãƒ³ãƒ—', desc: 'é£Ÿæ–™ã¯å°‘ãªã„ãŒã€éŠƒã¨æ–§ã§å¤–æ•µã«å¯¾æŠ—ã§ãã‚‹ã€‚', inv: { soup:2, water:2, gun:1, axe:1, map:1, flashlight:1 } },
    { id: 's3', title: 'ğŸ’€ çµ¶æœ›', desc: 'ã‚¹ãƒ¼ãƒ—1ã€æ°´1ã€æ®ºè™«å‰¤1ã€‚é‹ã ã‘ãŒé ¼ã‚Šã ã€‚', inv: { soup:1, water:1, bugspray:1 } }
];

/** 
 * --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° ---
 */
let gameState = {
    day: 1,
    inventory: {}, // { soup: 3, water: 3, ... }
    family: [],    // [{id, hp, hunger, thirst, status...}]
    rescue: 0,
    expedition: null, // { charId, daysLeft, items:{} }
    active: false
};

// ã‚«ã‚¹ã‚¿ãƒ æº–å‚™ç”¨
let shopData = {
    soup: 0, water: 0, tools: [],
    capMax: 20
};

/** 
 * --- ç”»é¢é·ç§»ãƒ»åˆæœŸåŒ– ---
 */
function switchScreen(id) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// 1. ã‚·ãƒŠãƒªã‚ªé¸æŠ
function goToScenarioSelect() {
    switchScreen('screen-scenario');
    const div = document.getElementById('scenario-list');
    div.innerHTML = '';
    SCENARIOS.forEach(sc => {
        const btn = document.createElement('div');
        btn.className = 'mode-card';
        btn.innerHTML = `<h3>${sc.title}</h3><p>${sc.desc}</p>`;
        btn.onclick = () => startGame(sc.inv);
        div.appendChild(btn);
    });
}

// 2. ã‚«ã‚¹ã‚¿ãƒ æº–å‚™
function goToCustomPrep() {
    switchScreen('screen-custom');
    shopData = { soup:0, water:0, tools:[], capMax:20 };
    renderShop();
}

function setCustomDiff(level, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
    btn.classList.add('active-tab');
    if(level === 'easy') shopData.capMax = 30;
    if(level === 'normal') shopData.capMax = 20;
    if(level === 'hard') shopData.capMax = 10;
    renderShop();
}

function renderShop() {
    const cont = document.getElementById('shop-container');
    cont.innerHTML = '';
    
    // ã‚¹ãƒ¼ãƒ—ãƒ»æ°´
    ['soup','water'].forEach(key => {
        const el = document.createElement('div');
        el.className = 'shop-item';
        el.innerHTML = `
            <div>${ITEMS[key].icon}${ITEMS[key].name} (${ITEMS[key].cost})</div>
            <div class="counter-ctrl">
                <button onclick="modShopItem('${key}', -1)">-</button>
                <span>${shopData[key]}</span>
                <button onclick="modShopItem('${key}', 1)">+</button>
            </div>
        `;
        cont.appendChild(el);
    });

    // é“å…·
    Object.keys(ITEMS).forEach(key => {
        if(ITEMS[key].type !== 'tool') return;
        const el = document.createElement('div');
        el.className = 'shop-item';
        if(shopData.tools.includes(key)) el.classList.add('selected');
        el.innerHTML = `<div>${ITEMS[key].icon}${ITEMS[key].name}</div><div>${ITEMS[key].cost}pt</div>`;
        el.onclick = () => toggleShopTool(key);
        cont.appendChild(el);
    });

    // å®¹é‡è¨ˆç®—
    let used = shopData.soup + shopData.water; // cost1ãªã®ã§ãã®ã¾ã¾
    shopData.tools.forEach(t => used += ITEMS[t].cost);
    
    document.getElementById('cap-current').innerText = used;
    document.getElementById('cap-max').innerText = shopData.capMax;
    document.getElementById('cap-current').style.color = used > shopData.capMax ? 'red' : '#ffcc00';
}

function modShopItem(key, delta) {
    if(delta > 0) shopData[key]++;
    else if(shopData[key] > 0) shopData[key]--;
    renderShop();
}

function toggleShopTool(key) {
    const idx = shopData.tools.indexOf(key);
    if(idx >= 0) shopData.tools.splice(idx, 1);
    else shopData.tools.push(key);
    renderShop();
}

function startGameCustom() {
    let used = shopData.soup + shopData.water;
    shopData.tools.forEach(t => used += ITEMS[t].cost);
    
    if(used > shopData.capMax) { alert("å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã§ã™ï¼"); return; }
    if(used === 0 && !confirm("ä½•ã‚‚æŒãŸãšã«è¡Œãã¾ã™ã‹ï¼Ÿ")) return;

    const initialInv = { soup: shopData.soup, water: shopData.water };
    shopData.tools.forEach(t => initialInv[t] = 1);
    startGame(initialInv);
}

// 3. ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†å…±é€š
function startGame(inventory) {
    gameState = {
        day: 1,
        inventory: inventory,
        family: CHARACTERS.map(c => ({
            ...c,
            alive: true, location: 'home',
            hunger: 0, thirst: 0,
            sickness: false, injury: false
        })),
        rescue: 0,
        expedition: null,
        active: true
    };
    
    switchScreen('screen-game');
    updateGameUI();
    log("ã‚·ã‚§ãƒ«ã‚¿ãƒ¼ã®æ‰‰ã‚’é–‰ã˜ãŸã€‚é•·ã„æˆ¦ã„ãŒå§‹ã¾ã‚‹ã€‚");
}

/** 
 * --- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
 */
function updateGameUI() {
    document.getElementById('val-day').innerText = gameState.day;
    document.getElementById('val-rescue').innerText = gameState.rescue;

    // å®¶æ—æç”»
    const famArea = document.getElementById('family-area');
    famArea.innerHTML = '';
    gameState.family.forEach(char => {
        const div = document.createElement('div');
        div.className = `char-card ${!char.alive ? 'dead' : ''} ${char.location==='out' ? 'away' : ''}`;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ§‹ç¯‰
        let st = [];
        if(!char.alive) st.push("ğŸ’€ æ­»äº¡");
        else if(char.location === 'out') st.push("ğŸƒ æ¢ç´¢ä¸­");
        else {
            if(char.sickness) st.push("ğŸ¤¢ ç—…æ°—");
            if(char.injury) st.push("ğŸ¤• æ€ªæˆ‘");
            if(st.length === 0) st.push("å¥åº·");
        }
        
        div.innerHTML = `
            <div class="char-info">
                <span style="font-size:24px">${char.icon}</span>
                <div>
                    <div>${char.name}</div>
                    <small style="color:#aaa">${st.join(',')}</small>
                </div>
            </div>
        `;

        // æ“ä½œãƒ‘ãƒãƒ« (ç”Ÿå­˜ã‹ã¤åœ¨å®…æ™‚)
        if(char.alive && char.location === 'home') {
            const hPct = Math.min(100, char.hunger);
            const tPct = Math.min(100, char.thirst);
            
            div.innerHTML += `
                <div style="font-size:12px">ç©ºè…¹</div>
                <div class="status-bar"><div class="bar-fill" style="width:${hPct}%; background:${hPct>70?'red':'#ff9800'}"></div></div>
                <div style="font-size:12px">æ¸‡ã</div>
                <div class="status-bar"><div class="bar-fill" style="width:${tPct}%; background:${tPct>70?'red':'#03a9f4'}"></div></div>
                
                <div style="margin-top:5px; display:flex; gap:2px;">
                    <button onclick="feed('${char.id}','soup')">ğŸ¥«</button>
                    <button onclick="feed('${char.id}','water')">ğŸ’§</button>
                    <button onclick="heal('${char.id}')" ${(!char.sickness && !char.injury)?'disabled':''}>ğŸ’Š</button>
                </div>
            `;
        } else if(char.location === 'out') {
            div.innerHTML += `<div style="text-align:center; font-size:12px; margin-top:10px;">å¸°é‚„ã¾ã§: ${gameState.expedition.daysLeft}æ—¥</div>`;
        }
        famArea.appendChild(div);
    });

    // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæç”»
    const invArea = document.getElementById('inventory-area');
    invArea.innerHTML = '';
    Object.keys(gameState.inventory).forEach(k => {
        if(gameState.inventory[k] > 0) {
            const sp = document.createElement('span');
            sp.className = 'inv-badge';
            sp.innerText = `${ITEMS[k].icon} ${gameState.inventory[k]}`;
            invArea.appendChild(sp);
        }
    });

    // æ¢ç´¢ãƒœã‚¿ãƒ³åˆ¶å¾¡
    const btnExp = document.getElementById('btn-expedition');
    if(gameState.expedition) {
        btnExp.disabled = true;
        btnExp.innerText = "æ¢ç´¢ä¸­...";
    } else {
        const canGo = gameState.family.some(c => c.alive && c.location === 'home' && !c.sickness && !c.injury);
        btnExp.disabled = !canGo;
        btnExp.innerText = canGo ? "ğŸ” æ¢ç´¢ã¸å‡ºã™" : "èª°ã‚‚è¡Œã‘ãªã„";
    }
}

function feed(id, type) {
    if(gameState.inventory[type] > 0) {
        gameState.inventory[type]--;
        const c = gameState.family.find(x => x.id === id);
        if(type === 'soup') c.hunger = Math.max(0, c.hunger - 50);
        else c.thirst = Math.max(0, c.thirst - 50);
        updateGameUI();
    } else {
        alert("åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“");
    }
}

function heal(id) {
    if(gameState.inventory.medkit > 0) {
        gameState.inventory.medkit--;
        const c = gameState.family.find(x => x.id === id);
        c.sickness = false;
        c.injury = false;
        log(`${c.name} ã‚’æ²»ç™‚ã—ãŸã€‚`);
        updateGameUI();
    } else {
        alert("æ•‘æ€¥ç®±ãŒã‚ã‚Šã¾ã›ã‚“");
    }
}

function log(msg) {
    const p = document.createElement('p');
    p.innerHTML = msg;
    const box = document.getElementById('journal-log');
    box.prepend(p);
}

/**
 * --- æ¢ç´¢ã‚·ã‚¹ãƒ†ãƒ  ---
 */
function openExpedition() {
    document.getElementById('modal-overlay').style.display = 'flex';
    const sel = document.getElementById('sel-exp-char');
    sel.innerHTML = '';
    gameState.family.forEach(c => {
        if(c.alive && c.location === 'home' && !c.sickness && !c.injury) {
            const op = document.createElement('option');
            op.value = c.id;
            op.innerText = c.name;
            sel.appendChild(op);
        }
    });
    
    // è£…å‚™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°ï¼ˆæ‰€æŒã—ã¦ã„ãªã‘ã‚Œã°disabledï¼‰
    ['mask', 'map', 'gun'].forEach(k => {
        const chk = document.getElementById('chk-'+k);
        chk.checked = false;
        chk.disabled = !gameState.inventory[k];
    });
}

function confirmExpedition() {
    const cid = document.getElementById('sel-exp-char').value;
    if(!cid) return;

    const char = gameState.family.find(x => x.id === cid);
    char.location = 'out';

    gameState.expedition = {
        charId: cid,
        daysLeft: 3 + Math.floor(Math.random()*2),
        hasMask: document.getElementById('chk-mask').checked,
        hasMap: document.getElementById('chk-map').checked,
        hasGun: document.getElementById('chk-gun').checked
    };

    document.getElementById('modal-overlay').style.display = 'none';
    log(`<strong>${char.name}</strong> ãŒæ¢ç´¢ã¸å‡ºç™ºã—ãŸã€‚`);
    updateGameUI();
}

/**
 * --- æ—¥æ•°é€²è¡Œ ---
 */
function nextDay() {
    if(!gameState.active) return;
    gameState.day++;
    log(`<b>--- Day ${gameState.day} ---</b>`);

    // 1. å®¶æ—ã®çŠ¶æ…‹æ‚ªåŒ–
    let someoneAlive = false;
    gameState.family.forEach(c => {
        if(c.alive) {
            if(c.location === 'home') {
                c.hunger += 15;
                c.thirst += 20;
                
                // æ­»äº¡åˆ¤å®š
                if(c.hunger >= 100 || c.thirst >= 100) {
                    c.alive = false;
                    log(`<span style="color:red">ğŸ’€ ${c.name} ã¯æ­»äº¡ã—ãŸ...</span>`);
                }
            }
            if(c.alive) someoneAlive = true;
        }
    });

    if(!someoneAlive) {
        gameOver("å…¨æ»…ã—ã¾ã—ãŸ...", false);
        return;
    }

    // 2. æ¢ç´¢æ›´æ–°
    if(gameState.expedition) {
        gameState.expedition.daysLeft--;
        if(gameState.expedition.daysLeft <= 0) resolveExpedition();
    }

    // 3. ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
    if(Math.random() < 0.5) triggerEvent();

    // 4. æ•‘åŠ©ãƒã‚§ãƒƒã‚¯ (ãƒ©ã‚¸ã‚ªæ‰€æŒã§ç¢ºç‡UP)
    if(gameState.inventory.radio) {
        gameState.rescue += 5 + Math.floor(Math.random()*10);
        if(Math.random() < 0.2) log("ğŸ“» ãƒ©ã‚¸ã‚ªã‹ã‚‰è»ã®é€šä¿¡ã‚’å‚å—ã—ãŸï¼");
    }
    
    if(gameState.rescue >= 100) {
        gameOver("è»ã®æ•‘åŠ©éšŠãŒåˆ°ç€ã—ãŸï¼ç”Ÿå­˜æˆåŠŸï¼", true);
        return;
    }

    updateGameUI();
}

function resolveExpedition() {
    const exp = gameState.expedition;
    const char = gameState.family.find(c => c.id === exp.charId);
    char.location = 'home';
    gameState.expedition = null;
    
    // ã‚¢ã‚¤ãƒ†ãƒ ç™ºè¦‹
    let found = [];
    let chance = 0.4;
    if(exp.hasMap) chance += 0.3; // åœ°å›³ãƒœãƒ¼ãƒŠã‚¹

    if(Math.random() < chance) found.push('soup');
    if(Math.random() < chance) found.push('water');
    if(Math.random() < 0.3) {
        const tools = Object.keys(ITEMS).filter(k => ITEMS[k].type === 'tool');
        found.push(tools[Math.floor(Math.random()*tools.length)]);
    }

    found.forEach(k => {
        gameState.inventory[k] = (gameState.inventory[k]||0)+1;
    });

    let msg = `<strong>${char.name}</strong> ãŒå¸°é‚„ã—ãŸã€‚`;
    if(found.length) msg += ` åç©«: ${found.map(k=>ITEMS[k].name).join(',')}`;
    else msg += ` æˆæœã¯ãªã‹ã£ãŸã€‚`;

    // ãƒªã‚¹ã‚¯åˆ¤å®š
    if(!exp.hasMask && Math.random() < 0.3) {
        char.sickness = true;
        msg += ` <span style="color:red">ç—…æ°—ã«ã‹ã‹ã£ãŸã‚ˆã†ã ã€‚</span>`;
    }
    if(!exp.hasGun && Math.random() < 0.3) {
        char.injury = true;
        msg += ` <span style="color:red">æ€ªæˆ‘ã‚’ã—ã¦æˆ»ã£ã¦ããŸã€‚</span>`;
    }

    log(msg);
}

function triggerEvent() {
    // ç°¡æ˜“ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ
    const events = [
        { text: "ã‚´ã‚­ãƒ–ãƒªã®ç¾¤ã‚ŒãŒç¾ã‚ŒãŸï¼", req: "bugspray", alt: "axe", failDmg: 20, okMsg: "é§†é™¤ã—ãŸã€‚", failMsg: "ä¸è¡›ç”Ÿã§ä½“èª¿æ‚ªåŒ–ã€‚" },
        { text: "å¼·ç›—ãŒä¾µå…¥ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ï¼", req: "gun", alt: "axe", failLoss: "soup", okMsg: "æ’ƒé€€ã—ãŸã€‚", failMsg: "é£Ÿæ–™ã‚’å¥ªã‚ã‚ŒãŸã€‚" },
        { text: "é€šæ°—å£ãŒæ•…éšœã—ãŸï¼", req: "mask", failDmg: 30, okMsg: "ä¿®ç†æˆåŠŸã€‚", failMsg: "æœ‰æ¯’ã‚¬ã‚¹ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚" },
        { text: "æš—é—‡ã§ç‰©éŸ³ãŒã™ã‚‹...", req: "flashlight", failLoss: "water", okMsg: "ãŸã ã®ãƒã‚ºãƒŸã ã£ãŸã€‚", failMsg: "æ°´ã‚’ã“ã¼ã—ã¦ã—ã¾ã£ãŸã€‚" }
    ];

    const ev = events[Math.floor(Math.random() * events.length)];
    let win = false;
    
    // é“å…·ãƒã‚§ãƒƒã‚¯ (req ã¾ãŸã¯ alt ã‚’æŒã£ã¦ã„ã‚Œã°OK)
    if((ev.req && gameState.inventory[ev.req]) || (ev.alt && gameState.inventory[ev.alt])) {
        win = true;
    }

    log(`[äº‹ä»¶] ${ev.text}`);
    if(win) {
        log(`<span style="color:#4caf50">â¤ ${ev.okMsg}</span>`);
    } else {
        log(`<span style="color:#ff5555">â¤ ${ev.failMsg}</span>`);
        if(ev.failDmg) {
            gameState.family.forEach(c => {
                if(c.alive && c.location === 'home') c.hunger += 10; // ãƒ€ãƒ¡ãƒ¼ã‚¸ã®ä»£ã‚ã‚Šã«ç©ºè…¹å¢—
            });
        }
        if(ev.failLoss && gameState.inventory[ev.failLoss]>0) {
            gameState.inventory[ev.failLoss]--;
        }
    }
}

function gameOver(msg, isWin) {
    gameState.active = false;
    switchScreen('screen-result');
    document.getElementById('res-title').innerText = isWin ? "SURVIVED!" : "GAME OVER";
    document.getElementById('res-title').style.color = isWin ? "#4caf50" : "#ff5555";
    document.getElementById('res-msg').innerText = msg + ` (è¨˜éŒ²: ${gameState.day}æ—¥)`;
}

</script>

</body>
</html>